<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - StarForge</title>
  <link rel="stylesheet" href="/css/user/profileDashboard.css">
  <link rel="stylesheet" href="/css/user/navbar-badges.css">
  <link rel="stylesheet" href="/css/user/userProfile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <%- include('../partials/user/navbar', { minimalNavbar: false }) %>
    <button class="sidebar-toggle1 d-md-none" id="sidebarToggle1" aria-label="Toggle Sidebar">
        <i class="fas fa-chevron-right" id="sidebarToggleIcon1"></i>
    </button>
  <%- include('../partials/user/profileSidebar', { user, currentPage: 'profile' }) %>

  <main class="main-content">
    <div class="content-wrapper">
      <div class="profile-container">
        
        <div class="profile-overview">
          <div class="profile-header">
            <div class="profile-image-container">
              <div class="profile-image">
                <% if (user.profileImage) { %>
                  <img src="/uploads/profiles/<%= user.profileImage %>" alt="Profile Picture" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; color: white;">
                    <%= user.fullName.split(' ').map(n => n[0]).join('') %>
                  </div>
                <% } else { %>
                  <%= user.fullName.split(' ').map(n => n[0]).join('') %>
                <% } %>
              </div>
              <div class="image-upload-overlay" onclick="openImageUploadModal()">
                <i class="fas fa-camera"></i>
              </div>
            </div>
            <div class="profile-info">
              <h1><%= user.fullName %></h1>
              <p><%= user.email %></p>
              <div class="profile-stats">
                <div class="stat-item">
                  <span class="stat-value"><%= orderCount || 0 %></span>
                  <span class="stat-label">Orders</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">â‚¹<%= (user.wallet?.balance || 0).toLocaleString('en-IN') %></span>
                  <span class="stat-label">Wallet</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value"><%= wishlistCount || 0 %></span>
                  <span class="stat-label">Wishlist</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="profile-details-section">
          <h2 class="section-title">
            <i class="fas fa-user"></i>
            Personal Information
          </h2>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Full Name</span>
              <span class="detail-value"><%= user.fullName %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email Address</span>
              <span class="detail-value"><%= user.email %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Mobile Number</span>
              <span class="detail-value"><%= user.mobile || 'Not provided' %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Member Since</span>
              <span class="detail-value"><%= new Date(user.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }) %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Referral Code</span>
              <span class="detail-value"><%= user.referralCode || 'Not available' %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Account Status</span>
              <span class="detail-value">
                <% if (user.isActive === true) { %>
                  <span style="color: #28a745; font-weight: 600;">
                    <i class="fas fa-check-circle"></i> Active
                  </span>
                <% } else { %>
                  <span style="color: #dc3545; font-weight: 600;">
                    <i class="fas fa-times-circle"></i> Inactive
                  </span>
                <% } %>
              </span>
            </div>
          </div>
          <button type="button" class="edit-profile-btn" onclick="openEditProfileModal()">
            <i class="fas fa-edit"></i> Edit Profile
          </button>
        </div>

      </div>
    </div>
  </main>

  <div id="editProfileModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-edit"></i>
          Edit Profile
        </h2>
        <button class="close-modal" onclick="closeEditProfileModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editProfileForm" action="/user/updateProfile" method="post" enctype="multipart/form-data" novalidate>
        <div class="form-group">
          <label class="form-label">Full Name *</label>
          <input type="text" name="name" class="form-input" value="<%= user.fullName %>" required>
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Email Address *</label>
          <input type="email" name="email" class="form-input" value="<%= user.email %>" required>
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Mobile Number</label>
          <input type="text" name="mobile" class="form-input" value="<%= user.mobile || '' %>" pattern="[0-9]{10}" maxlength="10" title="Please enter a valid 10-digit mobile number">
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Profile Image</label>
          <div class="file-upload-area" onclick="document.getElementById('profileImageEdit').click()">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">Click to select or drag and drop</div>
            <div class="upload-hint">JPG, PNG or GIF (max 5MB) - Optional</div>
          </div>
          <input type="file" id="profileImageEdit" name="profileImage" accept="image/*" style="display: none;">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i>
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="imageUploadModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-camera"></i>
          Update Profile Picture
        </h2>
        <button class="close-modal" onclick="closeImageUploadModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="imageUploadForm" action="/profile/upload-image" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <div class="file-upload-area" onclick="document.getElementById('profileImageInput').click()">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">Click to select or drag and drop</div>
            <div class="upload-hint">JPG, PNG or GIF (max 5MB)</div>
          </div>
          <input type="file" id="profileImageInput" name="profileImage" accept="image/*" required>
        </div>
        <div class="modal-actions">
          <% if (user.profileImage) { %>
            <button type="button" class="btn-secondary" onclick="removeProfileImage()" style="background: #ef4444;">
              <i class="fas fa-trash"></i>
              Remove Picture
            </button>
          <% } %>
          <button type="button" class="btn-secondary" onclick="closeImageUploadModal()">Cancel</button>
          <button type="submit" class="btn-primary">
            <i class="fas fa-upload"></i>
            Upload Picture
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/user/landingPage.js"></script>
  <script src="/js/user/userProfile.js"></script>
</body>

</html>