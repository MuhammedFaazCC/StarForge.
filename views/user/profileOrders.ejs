<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Orders - StarForge</title>
    <link rel="stylesheet" href="/css/user/profileDashboard.css" />
    <link rel="stylesheet" href="/css/user/profileOrders.css" />
    <link rel="stylesheet" href="/css/user/navbar-badges.css" />
  </head>
  <body>
    <%- include('../partials/user/navbar', { minimalNavbar: false }) %>
    <button
      class="sidebar-toggle1 d-md-none"
      id="sidebarToggle1"
      aria-label="Toggle Sidebar"
    >
      <i class="fas fa-chevron-right" id="sidebarToggleIcon1"></i>
    </button>
    <%- include('../partials/user/profileSidebar', { user, currentPage: 'orders'
    }) %>

    <main class="main-content">
      <div class="content-wrapper">
        <div class="profile-container">
          <header class="page-header">
            <div>
              <h1 class="page-title">My Orders</h1>
              <div class="breadcrumb"><a href="/">Home</a> / My Orders</div>
            </div>
          </header>

          <!-- Search Bar -->
          <section class="orders-search" style="margin: 0 0 1rem 0">
            <form
              id="ordersSearchForm"
              method="GET"
              action="/orders"
              style="display: flex; gap: 0.5rem; align-items: center"
            >
              <div style="position: relative; flex: 1">
                <input
                  id="ordersSearchInput"
                  type="text"
                  name="q"
                  value="<%= searchQuery || '' %>"
                  placeholder="Search by Order ID, Product name, or Status"
                  style="
                    width: 100%;
                    padding: 0.6rem 2.2rem 0.6rem 2.4rem;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                  "
                  autocomplete="off"
                />
                <i
                  class="fas fa-search"
                  style="
                    position: absolute;
                    left: 0.8rem;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #9ca3af;
                  "
                ></i>
                <% if (searchQuery) { %>
                <a
                  href="/orders"
                  title="Clear"
                  style="
                    position: absolute;
                    right: 0.6rem;
                    top: 50%;
                    transform: translateY(-50%);
                    color: #9ca3af;
                    text-decoration: none;
                  "
                >
                  <i class="fas fa-times"></i>
                </a>
                <% } %>
              </div>
              <button
                type="submit"
                class="btn btn-primary"
                style="padding: 0.55rem 1rem; border-radius: 8px"
              >
                Search
              </button>
            </form>
          </section>

          <div id="ordersContainer">
            <% if (orders && orders.length > 0) { %>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Order Id</th>
                  <th>Products</th>
                  <th>Placed On</th>
                  <th>Payment Method</th>
                  <th>Status</th>
                  <th>Total</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <% orders.forEach(order => { %>
              <tbody class="order-box">
                <tr>
                  <% console.log(orders.orderId) %>
                  <td><%= order.orderId %></td>
                  <td>
                    <ul class="product-list">
                      <% order.items.forEach(item => { %>
                      <li
                        class="product-item"
                        data-product-id="<%= item.productId?._id %>"
                      >
                        <div class="product-info">
                          <% const productImg = item.productId &&
                          item.productId.mainImage ? item.productId.mainImage :
                          '/images/no-image.png'; %>
                          <div class="product-image">
                            <img src="<%= productImg %>" alt="Product Image" />
                          </div>

                          <div class="product-details">
                            <div class="product-name">
                              <% let productName = 'Deleted Product'; if
                              (item.productId && item.productId.name) {
                              productName = item.productId.name; } else if
                              (item.name) { productName = item.name; } %> <%=
                              productName %> × <%= item.quantity %>
                            </div>

                            <span
                              class="orderStatus <%= item.status ? item.status.toLowerCase().replace(' ', '-') : 'unknown' %>"
                            >
                              <%= item.status || 'Placed' %>
                            </span>
                          </div>
                        </div>

                        <div class="product-actions">
                          <% const itemStatus = item.status || 'Placed'; const
                          cancellableStatuses = ['Placed', 'Ordered',
                          'Processing', 'Shipped']; const canCancelItem =
                          cancellableStatuses.includes(itemStatus) &&
                          order.status !== 'Cancelled'; const RETURN_DAYS_LIMIT
                          = 7; const deliveryDate = item.deliveredAt ||
                          order.deliveredAt; let canReturnItem = false; if
                          (itemStatus === 'Delivered' && deliveryDate) { const
                          daysSinceDelivery = Math.floor((new Date() - new
                          Date(deliveryDate)) / (1000 * 60 * 60 * 24));
                          canReturnItem = daysSinceDelivery <=
                          RETURN_DAYS_LIMIT; } %> <% if (itemStatus ===
                          'Cancelled') { %>
                          <span class="status-badge cancelled">Cancelled</span>
                          <% } else if (itemStatus === 'Return Requested') { %>
                          <span class="status-badge return-requested"
                            >Return Requested</span
                          >
                          <% } else if (itemStatus === 'Returned') { %>
                          <span class="status-badge returned">Returned</span>
                          <% } else if (canCancelItem && item.productId) { %>
                          <button
                            class="btn btn-sm btn-outline-danger cancel-item-btn"
                            data-order-id="<%= order._id %>"
                            data-product-id="<%= item.productId._id %>"
                          >
                            Cancel
                          </button>
                          <% } %> <% if (canReturnItem && item.productId) { %>
                          <button
                            class="btn btn-sm btn-outline-warning return-item-btn"
                            data-order-id="<%= order._id %>"
                            data-product-id="<%= item.productId._id %>"
                          >
                            Return
                          </button>
                          <% } %>
                        </div>
                      </li>
                      <% }); %>
                    </ul>
                  </td>
                  <td>
                    <%= order.createdAt.toLocaleDateString('en-GB', { day:
                    '2-digit', month: 'short', year: 'numeric' }) %>
                  </td>
                  <td>
                    <span
                      class="payment-method <%= order.paymentMethod ? order.paymentMethod.toLowerCase() : 'unknown' %>"
                    >
                      <% if (order.paymentMethod === 'Online') { %> Razorpay <%
                      } else if (order.paymentMethod === 'COD') { %> Cash on
                      Delivery <% } else if (order.paymentMethod === 'Wallet') {
                      %> Wallet <% } else { %> <%= order.paymentMethod ||
                      'Unknown' %> <% } %>
                    </span>
                  </td>
                  <td>
                    <span
                      class="orderStatus <%= order.status ? order.status.toLowerCase().replace(' ', '-') : 'unknown' %>"
                    >
                      <%= order.status || 'Unknown' %>
                    </span>
                  </td>
                  <td>₹<%= order.totalAmount.toFixed(2) || 'N/A' %></td>
                  <td>
                    <div class="action-buttons">
                      <a
                        href="/orders/<%= order._id %>"
                        class="btn btn-sm btn-primary"
                        >View</a
                      >
                    </div>
                  </td>
                </tr>
              </tbody>
              <% }); %>
            </table>
            <% } else { %>
            <div class="no-orders">
              <% if (searchQuery) { %>
              <h3>No matching orders found</h3>
              <p>
                No orders match "<%= searchQuery %>". Try a different Order ID,
                product name, or status.
              </p>
              <a href="/orders" class="btn btn-primary">Clear Search</a>
              <% } else { %>
              <h3>You have no orders yet</h3>
              <p>Explore our products and place your first order!</p>
              <a href="/products" class="btn btn-primary">Start Shopping</a>
              <% } %>
            </div>
            <% } %> <% if (pagination && pagination.totalPages > 1) { %>
            <div class="pagination-container">
              <div class="pagination-info">
                Showing <%= ((pagination.currentPage - 1) * 10) + 1 %> to <%=
                Math.min(pagination.currentPage * 10, pagination.totalOrders) %>
                of <%= pagination.totalOrders %> orders
              </div>
              <div class="pagination">
                <% if (pagination.hasPrevPage) { %>
                <a
                  href="?page=<%= pagination.prevPage %><% if (searchQuery) { %>&q=<%= searchQueryEncoded %><% } %>"
                  class="pagination-btn"
                >
                  ← Previous
                </a>
                <% } else { %>
                <span class="pagination-btn disabled">← Previous</span>
                <% } %> <% let startPage = Math.max(1, pagination.currentPage -
                2); let endPage = Math.min(pagination.totalPages,
                pagination.currentPage + 2); if (endPage - startPage < 4) { if
                (startPage === 1) { endPage = Math.min(pagination.totalPages,
                startPage + 4); } else { startPage = Math.max(1, endPage - 4); }
                } %> <% if (startPage > 1) { %>
                <a
                  href="?page=1<% if (searchQuery) { %>&q=<%= searchQueryEncoded %><% } %>"
                  class="pagination-btn"
                  >1</a
                >
                <% if (startPage > 2) { %>
                <span class="pagination-dots">...</span>
                <% } %> <% } %> <% for (let i = startPage; i <= endPage; i++) {
                %> <% if (i === pagination.currentPage) { %>
                <span class="pagination-btn active"><%= i %></span>
                <% } else { %>
                <a
                  href="?page=<%= i %><% if (searchQuery) { %>&q=<%= searchQueryEncoded %><% } %>"
                  class="pagination-btn"
                  ><%= i %></a
                >
                <% } %> <% } %> <% if (endPage < pagination.totalPages) { %> <%
                if (endPage < pagination.totalPages - 1) { %>
                <span class="pagination-dots">...</span>
                <% } %>
                <a
                  href="?page=<%= pagination.totalPages %><% if (searchQuery) { %>&q=<%= searchQueryEncoded %><% } %>"
                  class="pagination-btn"
                  ><%= pagination.totalPages %></a
                >
                <% } %> <% if (pagination.hasNextPage) { %>
                <a
                  href="?page=<%= pagination.nextPage %><% if (searchQuery) { %>&q=<%= searchQueryEncoded %><% } %>"
                  class="pagination-btn"
                >
                  Next →
                </a>
                <% } else { %>
                <span class="pagination-btn disabled">Next →</span>
                <% } %>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/user/landingPage.js"></script>
    <script src="/js/user/profileOrders.js"></script>
  </body>
</html>
