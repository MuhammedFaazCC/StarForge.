<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Cart | StarForge</title>
  <link rel="stylesheet" href="/css/user/navbar-badges.css">
  <link rel="stylesheet" href="/css/user/cart.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <%- include('../partials/user/navbar', { minimalNavbar: false }) %>

  <main class="cart-container">
    <h2>Shopping Cart</h2>

    <% if (!cart || cart.items.length===0) { %>
      <div class="empty-cart">Your cart is empty.</div>
      <% } else { %>
        <div class="cart-grid">
          <section class="cart-items">
            <% cart.items.forEach(item=> { %>
              <% if (item.productId) { const product=item.productId; %>
                <div class="cart-item <%= product.stock === 0 ? 'out-of-stock' : '' %>" data-item-id="<%= item._id %>">
                  <% if (product.mainImage || (product.additionalImages && product.additionalImages[0])) { %>
                    <img src="<%= product.mainImage || product.additionalImages[0] %>" alt="Product">
                  <% } else { %>
                    <div style="width:90px;height:90px;border:1px dashed #ccc;border-radius:6px;color:#888;display:flex;align-items:center;justify-content:center;font-size:12px;">No image</div>
                  <% } %>

                  <div class="item-details">
                    <h3>
                      <%= product.name %>
                    </h3>
                    <p>Price: ₹ <span class="item-price"><%= product.salesPrice ? product.salesPrice.toFixed(2) : product.price.toFixed(2) %></span>
                    </p>
                    <p>Subtotal: ₹ <span class="item-subtotal"><%= (item.quantity * (product.salesPrice || product.price)).toFixed(2) %></span></p>
                    <p>Status: <%= product.stock> 0 ? 'In Stock' : 'Out of Stock' %></p>
                    <div class="quantity-control">
                      <% if (product.stock> 0) { %>
                        <% const maxAllowed = Math.min(5, product.stock); %>
                        <button class="qty-btn decrease-btn" 
                                data-item-id="<%= item._id %>" 
                                data-change="-1"
                                <%= item.quantity === 1 ? 'disabled title="Minimum quantity reached"' : '' %>>
                          −
                        </button>
                        <input type="text" class="quantity-input" value="<%= item.quantity %>" readonly>
                        <button class="qty-btn increase-btn" 
                                data-item-id="<%= item._id %>" 
                                data-change="1"
                                data-max-allowed="<%= maxAllowed %>"
                                <%= item.quantity >= maxAllowed ? 'disabled title="' + (product.stock < 5 ? 'Stock limit reached' : 'Maximum limit (5) reached') + '"' : '' %>>
                          +
                        </button>
                        <div class="loading-spinner" style="display: none;">
                          <div class="spinner"></div>
                        </div>
                        <% } else { %>
                          <span class="out-text">Not available</span>
                          <% } %>
                    </div>

                    <button class="remove-btn" onclick="removeFromCart('<%= item._id %>')">Remove</button>
                  </div>
                </div>
                <% } %>
                  <% }) %>
          </section>

          <aside class="cart-summary">
  <h3>Order Summary</h3>
  <p>Total Items: <span id="total-items"><%= cart.items.reduce((sum, item) => sum + item.quantity, 0) %></span></p>
  <p>
    Total Price: ₹<span id="cart-total"><%= cart.items.reduce((sum, item) => {
      const price = Number(item.productId?.salesPrice) || 0;
      const qty = Number(item.quantity) || 0;
      return sum + price * qty;
    }, 0).toFixed(2) %></span>
  </p>
  <a href="/checkout" class="checkout-btn">Proceed to Checkout</a>
  </aside>

        </div>
        <% } %>
  </main>

  <script src="/js/user/cart.js"></script>
</body>

</html>