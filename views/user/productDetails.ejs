<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    <%= product.name %> | StarForge
  </title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/css/user/productDetails.css">
  <link rel="stylesheet" href="/css/user/navbar-badges.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <%- include('../partials/user/navbar', { minimalNavbar: false }) %>

    <div class="container py-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/products">All Products</a></li>
          <li class="breadcrumb-item active" aria-current="page">
            <%= product.name %>
          </li>
        </ol>
      </nav>

      <%
        function starRating(number) {
          const full = Math.floor(number);
          const half = number % 1 >= 0.5;
          const empty = 5 - full - (half ? 1 : 0);

          let html = '';
          for (let i = 0; i < full; i++) html += '<i class="fas fa-star"></i>';
          if (half) html += '<i class="fas fa-star-half-alt"></i>';
          for (let i = 0; i < empty; i++) html += '<i class="far fa-star"></i>';
          return html;
        }
      %>

      <div class="row mb-4">
        <div class="col-md-3">
          <div class="position-relative mb-2 zoom-wrap">
            <% if (product.mainImage) { %>
              <img id="mainProductImage" src="<%= product.mainImage %>" class="img-fluid zoomable"
                alt="<%= product.name %>">
              <% } else { %>
                <div id="mainProductImagePlaceholder" class="d-flex align-items-center justify-content-center"
                  style="height:220px;border:1px dashed #ccc;border-radius:6px;color:#888;font-size:14px;">
                  No image
                </div>
                <% } %>
                  <div id="imageNav" class="d-flex justify-content-between mt-2" style="gap:8px;">
                    <button type="button" id="prevImageBtn" class="btn btn-sm btn-outline-secondary">Prev</button>
                    <button type="button" id="nextImageBtn" class="btn btn-sm btn-outline-secondary">Next</button>
                  </div>
          </div>
          <div id="thumbStrip" class="d-flex flex-wrap gap-2">
            <% const thumbs=(product.additionalImages && product.additionalImages.length) ?
              product.additionalImages.filter(Boolean) : []; %>
              <% if ((product.mainImage) || thumbs.length) { %>
                <% if (product.mainImage) { %>
                  <img src="<%= product.mainImage %>" class="img-thumbnail p-thumb"
                    style="width: 60px; height: 60px; object-fit: cover;" alt="<%= product.name %> thumbnail"
                    data-src="<%= product.mainImage %>">
                  <% } %>
                    <% thumbs.forEach(image=> { %>
                      <img src="<%= image %>" class="img-thumbnail p-thumb"
                        style="width: 60px; height: 60px; object-fit: cover;" alt="<%= product.name %> thumbnail"
                        data-src="<%= image %>">
                      <% }) %>
                        <% } else { %>
                          <span class="text-muted" style="font-size: 0.9rem;">No additional images</span> 
                          <% } %>
          </div>
        </div>

        <div class="col-md-7">
          <h2>
            <%= product.name %>
          </h2>
          <div class="rating-stars mb-2">
            <% 
              const full = Math.floor(product.avgRating || 0);
              const half = (product.avgRating % 1) >= 0.5;
              const empty = 5 - full - (half ? 1 : 0);
            %>

            <% for (let i=0; i<full; i++) { %>
              <i class="fas fa-star"></i>
            <% } %>

            <% if (half) { %>
              <i class="fas fa-star-half-alt"></i>
            <% } %>

            <% for (let i=0; i<empty; i++) { %>
              <i class="far fa-star"></i>
            <% } %>

            <span class="text-muted">(<%= product.totalRatings %> reviews)</span>
          </div>
          <p class="text-muted">Brand: <%= product.brand %>
          </p>
          <% if (product.offer> 0) { %>
            <h4 class="text-danger">&#8377;<%= product.salePrice %> <small class="text-muted"><del>&#8377;<%=
                      product.price %></del></small></h4>
            <% } else { %>
              <h4 class="text-primary">&#8377;<%= product.price %>
              </h4>
              <% } %>

                <form action="/cart/add/<%= product._id %>" method="POST" class="my-3">
                  <label for="quantity" class="form-label">Quantity</label>
                  <div class="d-flex align-items-center mb-3">
                    <input type="number" name="quantity" id="quantity" value="1" min="1" class="form-control w-25 me-3">
                    <button type="submit" class="btn btn-warning me-2" <%=product.stock <=0 ? 'disabled' : '' %>>
                      <%= product.stock <=0 ? 'Out of Stock' : 'Add to Cart' %>
                    </button>
                    <button type="button" id="wishlistBtn" class="wishlist-btn <%= isInWishlist ? 'active' : '' %>"
                      data-product="<%= product._id %>">
                      <i class="<%= isInWishlist ? 'fas' : 'far' %> fa-heart"></i>
                    </button>
                  </div>
                </form>
                <h5 class="mt-3">Description</h5>
                <p>
                  <%= product.description %>
                </p>

        </div>

        <div id="reviews">
          <% if (user) { %>
            <form action="/product/<%= product._id %>/review" method="POST" class="my-3">
              <div class="mb-2">
                <label for="rating" class="form-label">
                  <h5>Rating</h5>
                </label>
                <div class="rating-input" id="ratingInput">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <i class="far fa-star" data-value="<%= i %>"></i>
                  <% } %>
                </div>

                <input type="hidden" name="rating" id="ratingValue" value="0">
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">Comment</label>
                <textarea name="comment" class="form-control" rows="3" required></textarea>
              </div>
              <button type="submit" class="btn btn-dark">Submit Review</button>
            </form>
            <% } else { %>
              <p class="text-muted">Please <a href="/login">login</a> to write a review.</p>
              <% } %>

                <% if (reviews.length===0) { %>
                  <p>No reviews yet.</p>
                  <% } else { %>
                    <div class="row">
                      <% reviews.forEach(review=> { %>
                        <div class="col-md-6">
                          <div class="review-card">
                            <div class="review-user">
                              <%= review.user.fullName %>
                            </div>
                            <div class="rating-stars mb-1">
                              <% for (let i=1; i <=5; i++) { %>
                                <i class="<%= i <= review.rating ? 'fas fa-star' : 'far fa-star' %>"></i>
                                <% } %>
                            </div>
                            <p>
                              <%= review.comment %>
                            </p>
                            <div class="review-date">
                              <%= new Date(review.createdAt).toDateString() %>
                            </div>
                          </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>
        </div>

        <div class="mt-5">
          <h4>You May Also Like</h4>
          <div class="row">
            <% relatedProducts.forEach(prod=> { %>
              <div class="col-6 col-md-2">
                <div class="card mb-4">
                  <% if (prod.mainImage) { %>
                    <img src="<%= prod.mainImage %>" class="card-img-top" alt="<%= prod.name %>">
                    <% } else { %>
                      <div class="d-flex align-items-center justify-content-center"
                        style="height:150px;border:1px dashed #ccc;border-radius:6px;color:#888;font-size:12px;">No
                        image</div>
                      <% } %>

                        <div class="card-body">
                          <h6 class="card-title">
                            <%= prod.name %>
                          </h6>
                          <p class="card-text">&#8377;<%= prod.salesPrice %>
                          </p>
                          <a href="/product/<%= prod._id %>" class="btn btn-outline-dark btn-sm">View</a>
                        </div>
                </div>
              </div>
              <% }) %>
          </div>
        </div>
        <div class="sticky-cart-bar">
          <span style="font-weight:600;">₹<%= product.salePrice || product.price %></span>
          <button id="mobileAddToCart" class="btn btn-warning">Add to Cart</button>
        </div>
      </div>

      <%- include('../partials/user/footer') %>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/user/productDetails.js"></script>

</body>

</html>