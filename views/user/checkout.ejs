<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | StarForge</title>
  <link rel="stylesheet" href="/css/user/checkout.css" />
</head>
<body>

  <nav class="top-navbar">
    <a href="/" class="navbar-brand">StarForge.</a>
    <div class="navbar-user">
      <span>Welcome back, <%= user.fullName %></span>
    </div>
  </nav>

  <main class="checkout-container">
    <h2>Checkout</h2>

    <form action="/checkout" method="POST" id="checkoutForm">
        <input type="hidden" name="selectedAddressId" id="selectedAddressId" />
        
        <div class="checkout-grid">

        <section class="shipping-section">
          <div class="section-header">
            <h3>Shipping Address</h3>
            <a href="/address/add" class="btn-primary">Add Address</a>
          </div>

          <% if (addresses.length === 0) { %>
            <div class="empty-state">
              <img src="/images/empty-address.svg" class="empty-icon" />
              <div class="empty-title">No addresses found</div>
              <div class="empty-description">You haven't added any delivery addresses yet.</div>
              <a href="/address/add" class="btn-primary">Add Address</a>
            </div>
          <% } else { %>
            <div class="address-selection-required" id="addressError" style="display: none; color: #dc3545; margin-bottom: 1rem; font-size: 0.9rem;">
              Please select a shipping address to continue.
            </div>
            <div class="card-grid">
              <% addresses.forEach(address => { %>
                <div class="info-card" data-address-id="<%= address._id %>">
                  <div class="card-header">
                    <span class="card-title"><%= address.fullName %></span>
                    <button type="button" class="edit-address-btn">Edit</button>
                  </div>
                  <p>
                    <%= address.address %><br />
                    <%= address.city %>, <%= address.district %>, <%= address.state %> - <%= address.pinCode %><br />
                    <strong><%= address.email %></strong>
                  </p>
                  <button type="button" class="btn-secondary" onclick="selectAddress('<%= address._id %>')">Select</button>
                </div>
              <% }) %>
            </div>
          <% } %>

          <h3>Payment Method</h3>
          <select name="paymentMethod" required>
            <option value="">Select Payment Method</option>
            <option value="COD">Cash on Delivery</option>
            <option value="online">Online Payment</option>
          </select>
        </section>

        <aside class="order-summary">
          <h3>Order Summary</h3>
          <ul>
            <% cartItems.forEach(item => { %>
              <li>
                <strong><%= item.product.name %></strong><br/>
                Qty: <%= item.quantity %> â€” $<%= item.subtotal.toFixed(2)%>
              </li>
            <% }) %>
          </ul>

          <p class="total">Total: $<%= total.toFixed(2) %></p>
          <button type="submit" class="checkout-btn">Place Order</button>
        </aside>
      </div>
    </form>
  </main>
  <div id="editAddressModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h2>Edit Profile</h2>
    <form id="editAddressForm" action="/editAddress" method="put">

        <label class="detail-label" for="address">Address</label>
              <textarea name="address" id="address"><%= addresses.address %></textarea>

              <label class="detail-label" for="district">District</label>
              <input type="text" name="district" value="<%= addresses.district %>" />

              <label class="detail-label" for="state">State</label>
              <input type="text" name="state" value="<%= addresses.state %>" />

              <label class="detail-label" for="city">City</label>
              <input type="text" name="city" value="<%= addresses.city %>" />

              <label class="detail-label" for="pinCode">Pin Code</label>
              <input type="text" name="pinCode" value="<%= addresses.pinCode %>" />

      <div class="modal-actions">
        <button type="button" onclick="closeModal()">Cancel</button>
        <button type="submit">Save Changes</button>
      </div>
    </form>
  </div>
</div>
  
<script src="/js/user/checkout.js"></script>
</body>
</html>