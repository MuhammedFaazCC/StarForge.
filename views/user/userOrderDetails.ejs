<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Details - StarForge</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/user/navbar-badges.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 0;
}

/* MAIN CONTAINER */
.main-content {
  max-width: 900px;
  margin: 100px auto 2rem auto;
  background: #fff;
  padding: 1.5rem;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* HEADINGS */
h1 {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 1.2rem;
}

/* SUMMARY SECTIONS */
.order-summary,
.coupon-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.coupon-summary {
  padding: 1rem;
  border-left: 4px solid #28a745;
  background: #f8f8f8;
}

.label {
  font-weight: 600;
  color: #555;
}

.value {
  font-weight: 700;
  color: #000;
}

/* ADDRESS SECTION */
.address-section {
  background: #eef4ff;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  border-left: 4px solid #007bff;
}

/* PRODUCT LIST */
.products-section h3 {
  margin-top: 1.5rem;
  margin-bottom: 0.8rem;
}

.product-item {
  display: flex;
  gap: 1rem;
  padding: 1rem 0;
  border-bottom: 1px solid #ddd;
}

.product-image {
  width: 90px;
  height: 90px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.product-info {
  flex: 1;
}

.product-name {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 0.3rem;
}

.item-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

/* BUTTONS */
.action-btn {
  padding: 0.6rem 1rem;
  border-radius: 6px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-cancel { background: #dc3545; color: #fff; }
.btn-return { background: #ffc107; color: #000; }
.btn-back { background: #6c757d; color: #fff; }
.btn-download { background: #28a745; color: #fff; }

.order-actions {
  margin-top: 2rem;
  display: flex;
  gap: 1rem;
}

@media (max-width: 600px) {

  /* NAVBAR FIX */
  .top-navbar {
    height: 70px !important;
    padding: 0 1rem !important;
  }

  .navbar-brand {
    font-size: 1.4rem !important;
  }

  .navbar-user i {
    font-size: 1.3rem !important;
  }

  /* MAIN CONTENT */
  .main-content {
    margin: 90px 0.5rem 1rem 0.5rem !important;
    padding: 1.2rem !important;
  }

  h1 {
    font-size: 1.5rem !important;
  }

  /* SUMMARY SECTIONS */
  .order-summary,
  .coupon-summary {
    grid-template-columns: 1fr !important;
    gap: 1rem !important;
    padding: 1rem !important;
  }

  .order-summary p,
  .coupon-summary p {
    font-size: 1rem !important;
  }

  /* ADDRESS BLOCK */
  .address-section {
    padding: 1rem !important;
    font-size: 1rem !important;
  }

  /* PRODUCTS SECTION */
  .products-section h3 {
    font-size: 1.3rem !important;
    margin-bottom: 1rem !important;
  }

  .product-item {
    flex-direction: column !important;
    width: 100% !important;
    gap: 1rem !important;
    padding: 1.2rem 0 !important;
  }

  .product-image {
    width: 100% !important;
    height: auto !important;
    max-height: 240px !important;
    border-radius: 10px !important;
  }

  .product-info {
    width: 100% !important;
  }

  .product-name {
    font-size: 1.1rem !important;
  }

  .product-details {
    font-size: 1rem !important;
  }

  .item-status {
    font-size: 0.95rem !important;
    padding: 0.3rem 0.6rem !important;
  }

  /* PRODUCT ACTION BUTTONS */
  .item-actions {
    width: 100% !important;
    flex-direction: column !important;
    gap: 0.7rem !important;
  }

  .item-actions .action-btn {
    width: 100% !important;
    padding: 0.8rem !important;
    font-size: 1rem !important;
  }

  /* BOTTOM ACTION BUTTONS */
  .order-actions {
    flex-direction: column !important;
    width: 100% !important;
    gap: 0.8rem !important;
    margin-top: 2rem !important;
  }

  .order-actions .action-btn {
    width: 100% !important;
    padding: 1rem !important;
    font-size: 1.05rem !important;
    border-radius: 8px !important;
  }
}
</style>
  
</head>
<body>
  <%- include('../partials/user/navbar', { minimalNavbar: false }) %>

  <main class="main-content">
    <h1>Order Details</h1>

    <%
      const finalItemStates = ['Delivered', 'Returned', 'Return Requested'];

      const hasAnyFinalItem = order.items.some(item =>
        finalItemStates.includes(item.status)
      );

      const allItemsCancelled = order.items.every(item =>
        (item.status || 'Ordered') === 'Cancelled'
      );
    %>

    <% if (order.status === 'Cancelled' || allItemsCancelled) { %>
      <div class="order-cancelled-label">
        Order Cancelled
      </div>
    <% } %>

    <div class="order-summary">
      <p><span class="label">Order ID:</span> <span class="value"><%= order.orderId %></span></p>
      <p><span class="label">Status:</span> <span class="value"><%= order.status %></span></p>
      <p><span class="label">Placed On:</span> <span class="value"><%= order.createdAt.toLocaleDateString('en-GB') %></span></p>
      <p><span class="label">Payment Method:</span> <span class="value">
        <% if (order.paymentMethod === 'Online') { %>
          Razorpay
        <% } else if (order.paymentMethod === 'COD') { %>
          Cash on Delivery
        <% } else if (order.paymentMethod === 'Wallet') { %>
          Wallet
        <% } else { %>
          <%= order.paymentMethod %>
        <% } %>
      </span></p>
      <p><span class="label">Total:</span> <span class="value">₹<%= order.totalAmount.toFixed(2) %></span></p>
    </div>

    <!-- Coupon Information Section -->
    <div class="coupon-summary">
      <% if (order.coupon && order.coupon.code && order.coupon.discountAmount > 0) { %>
        <p><span class="label">Coupon Code:</span> <span class="value coupon-code"><%= order.coupon.code %></span></p>
        <p><span class="label">Discount Amount:</span> <span class="value discount-amount">₹<%= order.coupon.discountAmount.toFixed(2) %></span></p>
        <% 
          // Calculate subtotal before discount
          const subtotalBeforeDiscount = order.totalAmount + order.coupon.discountAmount;
        %>
        <p><span class="label">Subtotal:</span> <span class="value">₹<%= subtotalBeforeDiscount.toFixed(2) %></span></p>
        <p><span class="label">Final Total:</span> <span class="value final-total">₹<%= order.totalAmount.toFixed(2) %></span></p>
      <% } else { %>
        <p><span class="label">Coupon:</span> <span class="value no-coupon">No coupon used</span></p>
      <% } %>
    </div>

    <div class="address-section">
      <div class="address-title">Delivery Address</div>
      <div class="address-text">
        <% if (order.deliveryAddress) { %>
          <strong><%= order.deliveryAddress.name %></strong><br>
          <%= order.deliveryAddress.addressLine %><br>
          <%= order.deliveryAddress.city %>, <%= order.deliveryAddress.state %> - <%= order.deliveryAddress.pincode %><br>
          <% if (order.deliveryAddress.phone) { %>
            <%= order.deliveryAddress.phone %>
          <% } %>
        <% } else if (order.address) { %>
          <%= order.address %>
        <% } else { %>
          <em>No delivery address available</em>
        <% } %>
      </div>
    </div>

    <div class="products-section">
      <h3>Products</h3>
      <% order.items.forEach(item => { %>
        <div class="product-item">
          <img class="product-image" src="<%= item.productId?.mainImage || '/images/no-image.png' %>" alt="<%= item.productId?.name || 'Product' %>">
          <div class="product-info">
            <div class="product-name"><% if (!item.productId) { %> <span class="badge bg-secondary">Product removed</span> <% } %> <%= item.productId?.name || 'Unknown Product' %></div>
            <div class="product-details">
              Quantity: <%= item.quantity %> × ₹<%= item.adjustedUnitPrice.toFixed(2) %> = ₹<%= (item.adjustedUnitPrice * item.quantity).toFixed(2) %>
              <br>
              <span class="item-status status-<%= (item.status || 'ordered').toLowerCase() %>">
                Status: <%= item.status || 'Ordered' %>
              </span>
            </div>
          </div>
          <div class="item-actions" data-product-id="<%= item.productId ? item.productId._id : '' %>">
            <% 
              const itemStatus = item.status || 'Placed';
              const orderStatus = order.status;
              
              // Enhanced cancellation logic - allow for pending, shipped statuses
              const cancellableStatuses = ['Placed', 'Ordered', 'Processing', 'Shipped'];
              const canCancelItem = cancellableStatuses.includes(itemStatus) && 
                                   orderStatus !== 'Cancelled';
              
              // Return logic with time limit check
              const RETURN_DAYS_LIMIT = 7;
              const deliveryDate = item.deliveredAt || order.deliveredAt;
              let canReturnItem = false;
              let returnMessage = '';
              
              if (itemStatus === 'Delivered' && deliveryDate) {
                const daysSinceDelivery = Math.floor((new Date() - new Date(deliveryDate)) / (1000 * 60 * 60 * 24));
                canReturnItem = daysSinceDelivery <= RETURN_DAYS_LIMIT;
                if (!canReturnItem) {
                  returnMessage = `Return period expired (${RETURN_DAYS_LIMIT} days limit)`;
                } else {
                  returnMessage = `${RETURN_DAYS_LIMIT - daysSinceDelivery} days left to return`;
                }
              }
            %>
            
            <% if (itemStatus === 'Cancelled') { %>
              <div class="cancelled-badge">
                Cancelled
              </div>
            <% } else if (itemStatus === 'Return Requested') { %>
              <div class="cancelled-badge" style="background-color: #fff3e0; color: #f57c00;">
                Return Requested
              </div>
            <% } else if (itemStatus === 'Returned') { %>
              <div class="cancelled-badge" style="background-color: #fce4ec; color: #c2185b;">
                Returned
              </div>
            <% } else if (itemStatus === 'Return Declined') { %>
              <div class="cancelled-badge">
                Return Declined
              </div>
            <% } else if (canCancelItem) { %>
              <button class="action-btn btn-cancel-item" onclick="cancelSingleItem('<%= order._id %>', '<%= item.productId ? item.productId._id : '' %>')" <%= !item.productId ? 'disabled' : '' %>>

                Cancel Item
              </button>
            <% } %>
            
            <% if (canReturnItem) { %>
              <button class="action-btn btn-return-item" onclick="requestReturnItem('<%= order._id %>', '<%= item.productId ? item.productId._id : '' %>')" <%= !item.productId ? 'disabled' : '' %>>
                Return Item
              </button>
              <div class="return-info" style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                <%= returnMessage %>
              </div>
            <% } else if (itemStatus === 'Delivered' && !canReturnItem && returnMessage) { %>
              <div class="return-expired" style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                <%= returnMessage %>
              </div>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>

    <div class="order-actions">
      <% 
        // Enhanced logic to properly check if order can be cancelled
        const cancellableOrderStatuses = ['Pending', 'Placed', 'Processing'];

        const canCancelOrder =
          cancellableOrderStatuses.includes(order.status) &&
          order.status !== 'Cancelled' &&
          !allItemsCancelled &&
          !hasAnyFinalItem;

        const canReturnOrder = order.status === 'Delivered' && 
                               order.status !== 'Cancelled' && 
                               !allItemsCancelled;
      %>
      
      <% if (canCancelOrder) { %>
        <button class="action-btn btn-cancel" id="cancelOrderBtn" onclick="cancelOrder('<%= order._id %>')">
          Cancel Order
        </button>
      <% } %>
      
      <% if (canReturnOrder) { %>
        <button class="action-btn btn-return" onclick="requestReturn('<%= order._id %>')">
          Request Return
        </button>
      <% } %>
      
      <a href="/order/invoice/<%= order._id %>" class="action-btn btn-download" target="_blank">
        Download Invoice
      </a>
      
      <a href="/orders" class="action-btn btn-back">
        Back to Orders
      </a>
    </div>
  </main>
  
  <script>
    // Global variable to track if any cancellation is in progress
    let cancellationInProgress = false;

    function disableAllCancelButtons() {
      const cancelButtons = document.querySelectorAll('.btn-cancel, .btn-cancel-item');
      cancelButtons.forEach(button => {
        button.disabled = true;
        button.classList.add('btn-processing');
        const originalText = button.textContent;
        button.setAttribute('data-original-text', originalText);
        if (button.classList.contains('btn-cancel')) {
          button.innerHTML = '<span>Cancelling Order...</span>';
        } else {
          button.innerHTML = '<span>Cancelling...</span>';
        }
      });
      cancellationInProgress = true;
    }

    function enableAllCancelButtons() {
      const cancelButtons = document.querySelectorAll('.btn-cancel, .btn-cancel-item');
      cancelButtons.forEach(button => {
        button.disabled = false;
        button.classList.remove('btn-processing');
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
          button.textContent = originalText;
        }
      });
      cancellationInProgress = false;
    }

    async function cancelOrder(orderId) {
      if (cancellationInProgress) {
        return;
      }

      const result = await Swal.fire({
        title: 'Cancel Order?',
        text: 'Are you sure you want to cancel this order? This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, Cancel Order',
        cancelButtonText: 'Keep Order'
      });

      if (result.isConfirmed) {
        disableAllCancelButtons();
        
        try {
          const response = await fetch(`/order/cancel/${orderId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          const data = await response.json();

          if (data.success) {
            // IMMEDIATELY UPDATE THE UI - Hide cancel order button and show cancelled banner
            const cancelOrderBtn = document.querySelector('#cancelOrderBtn');
            if (cancelOrderBtn) {
              cancelOrderBtn.style.display = 'none';
            }
            
            // Add order cancelled banner if not already present
            const mainContent = document.querySelector('.main-content');
            const existingBanner = document.querySelector('.order-cancelled-label');
            if (!existingBanner && mainContent) {
              const banner = document.createElement('div');
              banner.className = 'order-cancelled-label';
              banner.innerHTML = 'Order Cancelled';
              const h1 = mainContent.querySelector('h1');
              if (h1) {
                h1.insertAdjacentElement('afterend', banner);
              }
            }
            
            // Update order status in summary
            const statusValue = document.querySelector('.order-summary p:nth-child(2) .value');
            if (statusValue) {
              statusValue.textContent = 'Cancelled';
            }
            
            // Update all item statuses and hide their cancel buttons
            const itemActionsElements = document.querySelectorAll('.item-actions');
            itemActionsElements.forEach(itemActions => {
              const cancelItemBtn = itemActions.querySelector('.btn-cancel-item');
              if (cancelItemBtn) {
                itemActions.innerHTML = `
                  <div class="cancelled-badge">
                    Cancelled
                  </div>
                `;
              }
            });
            
            // Update all item statuses in product details
            const statusSpans = document.querySelectorAll('.item-status');
            statusSpans.forEach(statusSpan => {
              statusSpan.textContent = 'Status: Cancelled';
              statusSpan.className = 'item-status status-cancelled';
            });
            
            await Swal.fire({
              title: 'Order Cancelled!',
              text: data.message,
              icon: 'success',
              confirmButtonColor: '#28a745'
            });
            
            // Don't force refresh - the UI has been updated correctly
            console.log('Order cancellation UI update completed successfully');
          } else {
            enableAllCancelButtons();
            throw new Error(data.message || 'Failed to cancel order');
          }
        } catch (error) {
          enableAllCancelButtons();
          await Swal.fire({
            title: 'Error!',
            text: error.message || 'Something went wrong while cancelling the order.',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      }
    }

    async function requestReturn(orderId) {
      const { value: reason } = await Swal.fire({
        title: 'Request Return',
        text: 'Please provide a reason for returning this order:',
        input: 'textarea',
        inputPlaceholder: 'Enter your reason for return...',
        inputAttributes: {
          'aria-label': 'Return reason'
        },
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Submit Return Request',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
          if (!value || value.trim().length < 10) {
            return 'Please provide a detailed reason (at least 10 characters)';
          }
        }
      });

      if (reason) {
        try {
          const response = await fetch(`/order/return/${orderId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason.trim() })
          });

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              title: 'Return Request Submitted!',
              text: data.message,
              icon: 'success',
              confirmButtonColor: '#28a745'
            });
            window.location.reload();
          } else {
            throw new Error(data.message || 'Failed to submit return request');
          }
        } catch (error) {
          await Swal.fire({
            title: 'Error!',
            text: error.message || 'Something went wrong while submitting the return request.',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      }
    }

    async function cancelSingleItem(orderId, productId) {
      if (cancellationInProgress) {
        return;
      }

      const result = await Swal.fire({
        title: 'Cancel Item?',
        text: 'Are you sure you want to cancel this item? This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, Cancel Item',
        cancelButtonText: 'Keep Item'
      });

      if (result.isConfirmed) {
        disableAllCancelButtons();
        
        try {
          const response = await fetch(`/cancelItem/${orderId}/${productId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          const data = await response.json();

          if (data.success) {
            // IMMEDIATELY UPDATE THE UI - Remove the cancel button and show cancelled badge
            const itemActionsDiv = document.querySelector(`[data-product-id="${productId}"]`);
            if (itemActionsDiv) {
              itemActionsDiv.innerHTML = `
                <div class="cancelled-badge">
                  Cancelled
                </div>
              `;
              
              // Update the item status in the product details
              const productItem = itemActionsDiv.closest('.product-item');
              if (productItem) {
                const statusSpan = productItem.querySelector('.item-status');
                if (statusSpan) {
                  statusSpan.textContent = 'Status: Cancelled';
                  statusSpan.className = 'item-status status-cancelled';
                }
              }
            }
            
            // Update the total amount displayed on the page
            if (data.newOrderTotal !== undefined) {
              const orderSummary = document.querySelector('.order-summary');
              if (orderSummary) {
                const totalParagraph = orderSummary.querySelector('p:last-child .value');
                if (totalParagraph) {
                  totalParagraph.textContent = `₹${data.newOrderTotal.toFixed(2)}`;
                }
              }
            }
            
            // Check if all items are now cancelled and update order status
            if (data.orderFullyCancelled) {
              // Add order cancelled banner if not already present
              const mainContent = document.querySelector('.main-content');
              const existingBanner = document.querySelector('.order-cancelled-label');
              if (!existingBanner && mainContent) {
                const banner = document.createElement('div');
                banner.className = 'order-cancelled-label';
                banner.innerHTML = 'Order Cancelled';
                const h1 = mainContent.querySelector('h1');
                if (h1) {
                  h1.insertAdjacentElement('afterend', banner);
                }
              }
              
              // Hide the main cancel order button if it exists
              const cancelOrderBtn = document.querySelector('#cancelOrderBtn');
              if (cancelOrderBtn) {
                cancelOrderBtn.style.display = 'none';
              }
              
              // Update order status in summary
              const statusValue = document.querySelector('.order-summary p:nth-child(2) .value');
              if (statusValue) {
                statusValue.textContent = 'Cancelled';
              }
            }
            
            let message = data.message;
            let htmlContent = `<div style="text-align: left;">`;
            
            if (data.refundAmount && data.refundAmount > 0) {
              htmlContent += `<p><strong>✓ Item cancelled successfully</strong></p>`;
              htmlContent += `<p><strong>Refund Amount:</strong> ₹${data.refundAmount.toFixed(2)}</p>`;
              htmlContent += `<p><em>The refund has been credited to your wallet.</em></p>`;
            } else {
              htmlContent += `<p><strong>✓ Item cancelled successfully</strong></p>`;
            }
            
            if (data.couponRemoved) {
              htmlContent += `<p><strong>Coupon Adjustment:</strong></p>`;
              htmlContent += `<p><em>The coupon was removed as the remaining order total no longer meets the minimum requirement.</em></p>`;
            }
            
            if (data.newOrderTotal !== undefined) {
              htmlContent += `<p><strong>Updated Order Total:</strong> ₹${data.newOrderTotal.toFixed(2)}</p>`;
            }
            
            htmlContent += `</div>`;
            
            await Swal.fire({
              title: 'Item Cancelled!',
              html: htmlContent,
              icon: 'success',
              confirmButtonColor: '#28a745',
              width: '500px'
            });
            
            // Re-enable remaining cancel buttons
            cancellationInProgress = false;
            const remainingCancelButtons = document.querySelectorAll('.btn-cancel, .btn-cancel-item');
            remainingCancelButtons.forEach(button => {
              button.disabled = false;
              button.classList.remove('btn-processing');
              const originalText = button.getAttribute('data-original-text');
              if (originalText) {
                button.textContent = originalText;
              }
            });
            
          } else {
            enableAllCancelButtons();
            throw new Error(data.error || 'Failed to cancel item');
          }
        } catch (error) {
          enableAllCancelButtons();
          await Swal.fire({
            title: 'Error!',
            text: error.message || 'Something went wrong while cancelling the item.',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      }
    }

    async function requestReturnItem(orderId, productId) {
      const { value: reason } = await Swal.fire({
        title: 'Request Item Return',
        text: 'Please provide a reason for returning this item:',
        input: 'textarea',
        inputPlaceholder: 'Enter your reason for return...',
        inputAttributes: {
          'aria-label': 'Return reason'
        },
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Submit Return Request',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
          if (!value || value.trim().length < 10) {
            return 'Please provide a detailed reason (at least 10 characters)';
          }
        }
      });

      if (reason) {
        try {
          const response = await fetch(`/returnItem/${orderId}/${productId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason.trim() })
          });

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              title: 'Return Request Submitted!',
              text: data.message,
              icon: 'success',
              confirmButtonColor: '#28a745'
            });
            window.location.reload();
          } else {
            await Swal.fire({
              title: 'Cannot Submit Return',
              text: data.message,
              icon: 'warning',
              confirmButtonColor: '#ffc107'
            });
          }
        } catch (error) {
          await Swal.fire({
            title: 'Error!',
            text: error.message || 'Something went wrong while submitting the return request.',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      }
    }
  </script>
</body>
</html>
