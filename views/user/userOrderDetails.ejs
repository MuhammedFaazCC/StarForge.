<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Details - StarForge</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/user/navbar-badges.css">
  <link rel="stylesheet" href="/css/user/userOrderDetails.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
</head>
<body>
  <%- include('../partials/user/navbar', { minimalNavbar: false }) %>

  <main class="main-content">
    <h1>Order Details</h1>

    <%
      const finalItemStates = ['Delivered', 'Returned', 'Return Requested'];

      const hasAnyFinalItem = order.items.some(item =>
        finalItemStates.includes(item.status)
      );

      const allItemsCancelled = order.items.every(item =>
        (item.status || 'Ordered') === 'Cancelled'
      );
    %>

    <% if (order.status === 'Cancelled' || allItemsCancelled) { %>
      <div class="order-cancelled-label">
        Order Cancelled
      </div>
    <% } %>

    <div class="order-summary">
      <p><span class="label">Order ID:</span> <span class="value"><%= order.orderId %></span></p>
      <p><span class="label">Status:</span> <span class="value"><%= order.status %></span></p>
      <p><span class="label">Placed On:</span> <span class="value"><%= order.createdAt.toLocaleDateString('en-GB') %></span></p>
      <p><span class="label">Payment Method:</span> <span class="value">
        <% if (order.paymentMethod === 'Online') { %>
          Razorpay
        <% } else if (order.paymentMethod === 'COD') { %>
          Cash on Delivery
        <% } else if (order.paymentMethod === 'Wallet') { %>
          Wallet
        <% } else { %>
          <%= order.paymentMethod %>
        <% } %>
      </span></p>
      <p><span class="label">Total:</span> <span class="value">₹<%= order.totalAmount.toFixed(2) %></span></p>
    </div>

    <!-- Coupon Information Section -->
    <div class="coupon-summary">
      <% if (order.coupon && order.coupon.code && order.coupon.discountAmount > 0) { %>
        <p><span class="label">Coupon Code:</span> <span class="value coupon-code"><%= order.coupon.code %></span></p>
        <p><span class="label">Discount Amount:</span> <span class="value discount-amount">₹<%= order.coupon.discountAmount.toFixed(2) %></span></p>
        <% 
          // Calculate subtotal before discount
          const subtotalBeforeDiscount = order.totalAmount + order.coupon.discountAmount;
        %>
        <p><span class="label">Subtotal:</span> <span class="value">₹<%= subtotalBeforeDiscount.toFixed(2) %></span></p>
        <p><span class="label">Final Total:</span> <span class="value final-total">₹<%= order.totalAmount.toFixed(2) %></span></p>
      <% } else { %>
        <p><span class="label">Coupon:</span> <span class="value no-coupon">No coupon used</span></p>
      <% } %>
    </div>

    <div class="address-section">
      <div class="address-title">Delivery Address</div>
      <div class="address-text">
        <% if (order.deliveryAddress) { %>
          <strong><%= order.deliveryAddress.name %></strong><br>
          <%= order.deliveryAddress.addressLine %><br>
          <%= order.deliveryAddress.city %>, <%= order.deliveryAddress.state %> - <%= order.deliveryAddress.pincode %><br>
          <% if (order.deliveryAddress.phone) { %>
            <%= order.deliveryAddress.phone %>
          <% } %>
        <% } else if (order.address) { %>
          <%= order.address %>
        <% } else { %>
          <em>No delivery address available</em>
        <% } %>
      </div>
    </div>

    <div class="products-section">
      <h3>Products</h3>
      <% order.items.forEach(item => { %>
        <div class="product-item">
          <img class="product-image" src="<%= item.productId?.mainImage || '/images/no-image.png' %>" alt="<%= item.productId?.name || 'Product' %>">
          <div class="product-info">
            <div class="product-name"><% if (!item.productId) { %> <span class="badge bg-secondary">Product removed</span> <% } %> <%= item.productId?.name || 'Unknown Product' %></div>
            <div class="product-details">
              Quantity: <%= item.quantity %> × ₹<%= item.adjustedUnitPrice.toFixed(2) %> = ₹<%= (item.adjustedUnitPrice * item.quantity).toFixed(2) %>
              <br>
              <span class="item-status status-<%= (item.status || 'ordered').toLowerCase() %>">
                Status: <%= item.status || 'Ordered' %>
              </span>
            </div>
          </div>
          <div class="item-actions" data-product-id="<%= item.productId ? item.productId._id : '' %>">
            <% 
              const itemStatus = item.status || 'Placed';
              const orderStatus = order.status;
              
              // Enhanced cancellation logic - allow for pending, shipped statuses
              const cancellableStatuses = ['Placed', 'Ordered', 'Processing', 'Shipped'];
              const canCancelItem = cancellableStatuses.includes(itemStatus) && 
                                   orderStatus !== 'Cancelled';
              
              // Return logic with time limit check
              const RETURN_DAYS_LIMIT = 7;
              const deliveryDate = item.deliveredAt || order.deliveredAt;
              let canReturnItem = false;
              let returnMessage = '';
              
              if (itemStatus === 'Delivered' && deliveryDate) {
                const daysSinceDelivery = Math.floor((new Date() - new Date(deliveryDate)) / (1000 * 60 * 60 * 24));
                canReturnItem = daysSinceDelivery <= RETURN_DAYS_LIMIT;
                if (!canReturnItem) {
                  returnMessage = `Return period expired (${RETURN_DAYS_LIMIT} days limit)`;
                } else {
                  returnMessage = `${RETURN_DAYS_LIMIT - daysSinceDelivery} days left to return`;
                }
              }
            %>
            
            <% if (itemStatus === 'Cancelled') { %>
              <div class="cancelled-badge">
                Cancelled
              </div>
            <% } else if (itemStatus === 'Return Requested') { %>
              <div class="cancelled-badge" style="background-color: #fff3e0; color: #f57c00;">
                Return Requested
              </div>
            <% } else if (itemStatus === 'Returned') { %>
              <div class="cancelled-badge" style="background-color: #fce4ec; color: #c2185b;">
                Returned
              </div>
            <% } else if (itemStatus === 'Return Declined') { %>
              <div class="cancelled-badge">
                Return Declined
              </div>
            <% } else if (canCancelItem) { %>
              <button class="action-btn btn-cancel-item" onclick="cancelSingleItem('<%= order._id %>', '<%= item.productId ? item.productId._id : '' %>')" <%= !item.productId ? 'disabled' : '' %>>

                Cancel Item
              </button>
            <% } %>
            
            <% if (canReturnItem) { %>
              <button class="action-btn btn-return-item" onclick="requestReturnItem('<%= order._id %>', '<%= item.productId ? item.productId._id : '' %>')" <%= !item.productId ? 'disabled' : '' %>>
                Return Item
              </button>
              <div class="return-info" style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                <%= returnMessage %>
              </div>
            <% } else if (itemStatus === 'Delivered' && !canReturnItem && returnMessage) { %>
              <div class="return-expired" style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                <%= returnMessage %>
              </div>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>

    <div class="order-actions">
      <% 
        // Enhanced logic to properly check if order can be cancelled
        const cancellableOrderStatuses = ['Pending', 'Placed', 'Processing'];

        const canCancelOrder =
          cancellableOrderStatuses.includes(order.status) &&
          order.status !== 'Cancelled' &&
          !allItemsCancelled &&
          !hasAnyFinalItem;

        const canReturnOrder = order.status === 'Delivered' && 
                               order.status !== 'Cancelled' && 
                               !allItemsCancelled;
      %>
      
      <% if (canCancelOrder) { %>
        <button class="action-btn btn-cancel" id="cancelOrderBtn" onclick="cancelOrder('<%= order._id %>')">
          Cancel Order
        </button>
      <% } %>
      
      <% if (canReturnOrder) { %>
        <button class="action-btn btn-return" onclick="requestReturn('<%= order._id %>')">
          Request Return
        </button>
      <% } %>
      
      <a href="/order/invoice/<%= order._id %>" class="action-btn btn-download" target="_blank">
        Download Invoice
      </a>
      
      <a href="/orders" class="action-btn btn-back">
        Back to Orders
      </a>
    </div>
  </main>
  
  <script src="/js/user/userOrderDetails.js"></script>
</body>
</html>
