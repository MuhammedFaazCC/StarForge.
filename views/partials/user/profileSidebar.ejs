<!-- Enhanced Profile Sidebar Partial -->
<aside class="profile-sidebar" id="profileSidebar">
    <div class="sidebar-header">
        <div class="profile-avatar">
            <% if (user.profileImage) { %>
                <img src="/uploads/profiles/<%= user.profileImage %>" alt="Profile Picture" class="profile-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="profile-initials" style="display: none;"><%= user.fullName.split(' ').map(n => n[0]).join('') %></div>
            <% } else { %>
                <div class="profile-initials"><%= user.fullName.split(' ').map(n => n[0]).join('') %></div>
            <% } %>
        </div>
        <div class="profile-info">
            <h3 class="profile-name"><%= user.fullName %></h3>
            <p class="profile-email"><%= user.email %></p>
            <div class="profile-status">
                <span class="status-indicator active"></span>
                <span class="status-text">Active</span>
            </div>
        </div>
    </div>

    <nav class="sidebar-nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="/LoadProfile" class="nav-link <%= currentPage === 'profile' ? 'active' : '' %>" data-page="profile">
                    <i class="nav-icon fas fa-user"></i>
                    <span class="nav-text">My Profile</span>
                    <% if (currentPage === 'profile') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>

            <li class="nav-item">
                <a href="/address" class="nav-link <%= currentPage === 'address' ? 'active' : '' %>" data-page="address">
                    <i class="nav-icon fas fa-map-marker-alt"></i>
                    <span class="nav-text">My Addresses</span>
                    <% if (currentPage === 'address') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>

            <li class="nav-item">
                <a href="/orders" class="nav-link <%= currentPage === 'orders' ? 'active' : '' %>" data-page="orders">
                    <i class="nav-icon fas fa-shopping-bag"></i>
                    <span class="nav-text">My Orders</span>
                    <% if (currentPage === 'orders') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>

            <li class="nav-item">
                <a href="/wishlist" class="nav-link <%= currentPage === 'wishlist' ? 'active' : '' %>" data-page="wishlist">
                    <i class="nav-icon fas fa-heart"></i>
                    <span class="nav-text">My Wishlist</span>
                    <% if (currentPage === 'wishlist') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>

            <li class="nav-item">
                <a href="/wallet" class="nav-link <%= currentPage === 'wallet' ? 'active' : '' %>" data-page="wallet">
                    <i class="nav-icon fas fa-wallet"></i>
                    <span class="nav-text">My Wallet</span>
                    <% if (currentPage === 'wallet') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="/referral" class="nav-link <%= currentPage === 'referral' ? 'active' : '' %>" data-page="referral">
                    <i class="nav-icon fas fa-users"></i>
                    <span class="nav-text">Referral Program</span>
                    <% if (currentPage === 'referral') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>

            <li class="nav-item nav-divider">
                <hr class="sidebar-divider">
            </li>
            
            <li class="nav-item">
                <a href="/changePassword" class="nav-link <%= currentPage === 'password' ? 'active' : '' %>" data-page="password">
                    <i class="nav-icon fas fa-lock"></i>
                    <span class="nav-text">Change Password</span>
                    <% if (currentPage === 'password') { %>
                        <span class="active-indicator"></span>
                    <% } %>
                </a>
            </li>

            <li class="nav-item">
                <a href="#" id="logout-btn" class="nav-link logout-link">
                    <i class="nav-icon fas fa-sign-out-alt"></i>
                    <span class="nav-text">Logout</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Mobile Toggle Button -->
    <button class="sidebar-toggle d-md-none" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>
</aside>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay d-md-none" id="sidebarOverlay"></div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Enhanced logout functionality
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        
        Swal.fire({
          title: 'Are you sure?',
          text: "You will be logged out of your account!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#fca120',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, logout',
          cancelButtonText: 'Cancel',
          reverseButtons: true,
          customClass: {
            popup: 'sidebar-swal-popup',
            confirmButton: 'sidebar-swal-confirm',
            cancelButton: 'sidebar-swal-cancel'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading state
            Swal.fire({
              title: 'Logging out...',
              text: 'Please wait',
              icon: 'info',
              allowOutsideClick: false,
              showConfirmButton: false,
              timer: 1500,
              timerProgressBar: true,
              customClass: {
                popup: 'sidebar-swal-popup'
              }
            }).then(() => {
              window.location.href = "/logout";
            });
          }
        });
      });
    }
    
    // Enhanced mobile sidebar toggle functionality
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('profileSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebarToggle && sidebar && overlay) {
      // Toggle sidebar
      sidebarToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleSidebar();
      });
      
      // Close sidebar when clicking overlay
      overlay.addEventListener('click', () => {
        closeSidebar();
      });
      
      // Close sidebar when clicking outside
      document.addEventListener('click', (e) => {
        if (window.innerWidth < 768 && 
            sidebar.classList.contains('show') && 
            !sidebar.contains(e.target) && 
            !sidebarToggle.contains(e.target)) {
          closeSidebar();
        }
      });
      
      // Handle escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sidebar.classList.contains('show')) {
          closeSidebar();
        }
      });
    }
    
    // Enhanced window resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (window.innerWidth >= 768) {
          closeSidebar();
        }
      }, 150);
    });
    
    // Add smooth scroll behavior for navigation links
    const navLinks = document.querySelectorAll('.nav-link[href^="/"]');
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        // Close mobile sidebar when navigating
        if (window.innerWidth < 768) {
          setTimeout(() => {
            closeSidebar();
          }, 100);
        }
        
        // Add loading state to clicked link
        const icon = link.querySelector('.nav-icon');
        const originalClass = icon.className;
        icon.className = 'nav-icon fas fa-spinner fa-spin';
        
        // Restore icon after a short delay (in case navigation is instant)
        setTimeout(() => {
          icon.className = originalClass;
        }, 1000);
      });
    });
    
    // Helper functions
    function toggleSidebar() {
      const isOpen = sidebar.classList.contains('show');
      if (isOpen) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }
    
    function openSidebar() {
      sidebar.classList.add('show');
      overlay.classList.add('show');
      document.body.classList.add('sidebar-open');
      
      // Focus management for accessibility
      const firstNavLink = sidebar.querySelector('.nav-link');
      if (firstNavLink) {
        setTimeout(() => firstNavLink.focus(), 300);
      }
    }
    
    function closeSidebar() {
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.classList.remove('sidebar-open');
      
      // Return focus to toggle button for accessibility
      if (document.activeElement && sidebar.contains(document.activeElement)) {
        sidebarToggle.focus();
      }
    }
    
    // Add active page indicator animation
    const activeLink = document.querySelector('.nav-link.active');
    if (activeLink) {
      activeLink.style.animationDelay = '0.5s';
      activeLink.classList.add('fade-in-up');
    }
    
    // Add hover effects for better UX
    const navItems = document.querySelectorAll('.nav-link');
    navItems.forEach(item => {
      item.addEventListener('mouseenter', () => {
        if (!item.classList.contains('active')) {
          item.style.transform = 'translateX(6px)';
        }
      });
      
      item.addEventListener('mouseleave', () => {
        if (!item.classList.contains('active')) {
          item.style.transform = '';
        }
      });
    });
  });
  
  // Add custom styles for SweetAlert
  const swalStyles = `
    <style>
      .sidebar-swal-popup {
        border-radius: 16px !important;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25) !important;
      }
      .sidebar-swal-confirm {
        background: linear-gradient(135deg, #fca120 0%, #e8940f 100%) !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 0.75rem 1.5rem !important;
        font-weight: 600 !important;
      }
      .sidebar-swal-cancel {
        background: #6c757d !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 0.75rem 1.5rem !important;
        font-weight: 600 !important;
      }
    </style>
  `;
  
  if (!document.querySelector('#sidebar-swal-styles')) {
    const styleElement = document.createElement('div');
    styleElement.id = 'sidebar-swal-styles';
    styleElement.innerHTML = swalStyles;
    document.head.appendChild(styleElement);
  }
</script>