<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - StarForge</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/admin/orders.css">
</head>

<body>
    <%- include('../partials/admin/navbar') %>

        <%- include('../partials/admin/sidepanel', { active:'orders' }) %>

            <div class="main-content" id="main-content">
                <div class="orders-section">
                    <div class="orders-header">
                        <h2>Orders</h2>
                        <a href="/admin/returns" class="return-requests-btn">
                            <i class="fas fa-undo"></i>
                            Return Requests
                            <% if (pendingReturnsCount > 0) { %>
                                <span class="notification-badge"><%= pendingReturnsCount %></span>
                            <% } %>
                        </a>
                    </div>
                    <form method="GET" action="/admin/orders" class="filter-bar">
                        <input type="text" name="search" placeholder="Search by name or email"
                            value="<%= search || '' %>">

                        <select name="status">
                            <option value="">All Statuses</option>
                            <option value="Processing" <%=status==='Processing' ? 'selected' : '' %>>Pending</option>
                            <option value="Placed" <%=status==='Placed' ? 'selected' : '' %>>Placed</option>
                            <option value="Shipped" <%=status==='Shipped' ? 'selected' : '' %>>Shipped</option>
                            <option value="Out for Delivery" <%=status==='Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
                            <option value="Delivered" <%=status==='Delivered' ? 'selected' : '' %>>Delivered</option>
                            <option value="Cancelled" <%=status==='Cancelled' ? 'selected' : '' %>>Cancelled</option>
                        </select>

                        <select name="sort">
                            <option value="desc" <%=sort==='desc' ? 'selected' : '' %>>Newest First</option>
                            <option value="asc" <%=sort==='asc' ? 'selected' : '' %>>Oldest First</option>
                        </select>

                        <button type="submit">Apply</button>
                        <a href="/admin/orders" class="btn-clear">Clear</a>
                    </form>

                    <div class="orders-container">
                        <% orders.forEach(order => { %>
                            <div class="order-card" data-order-id="<%= order._id %>">
                                <div class="order-header">
                                    <div class="order-info">
                                        <h3>Order #<%= order._id.toString().slice(-8) %></h3>
                                        <div class="order-meta">
                                            <span class="customer-name">
                                                <i class="fas fa-user"></i>
                                                <%= order.userId.fullName || order.userId.email %>
                                            </span>
                                            <span class="order-date">
                                                <i class="fas fa-calendar"></i>
                                                <%= order.createdAt.toLocaleDateString() %>
                                            </span>
                                            <span class="payment-method <%= order.paymentMethod ? order.paymentMethod.toLowerCase() : 'unknown' %>">
                                                <i class="fas fa-credit-card"></i>
                                                <% if (order.paymentMethod === 'Online') { %>
                                                    Razorpay
                                                <% } else if (order.paymentMethod === 'COD') { %>
                                                    COD
                                                <% } else if (order.paymentMethod === 'Wallet') { %>
                                                    Wallet
                                                <% } else { %>
                                                    <%= order.paymentMethod || 'Unknown' %>
                                                <% } %>
                                            </span>
                                            <span class="order-total">
                                                <i class="fas fa-dollar-sign"></i>
                                                $<%= order.totalAmount.toFixed(2) %>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="order-actions">
                                        <div class="order-status-update">
                                            <% const isFinalOrderStatus = ['Delivered', 'Returned', 'Cancelled'].includes(order.status); %>
                                            <% if (!isFinalOrderStatus) { %>
                                                <select class="order-status-dropdown" data-order-id="<%= order._id %>" data-current-status="<%= order.status %>">
                                                    <option value="">Update Status</option>
                                                    <% 
                                                        const orderStatusOptions = ['Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'];
                                                        const currentIndex = orderStatusOptions.indexOf(order.status);
                                                        orderStatusOptions.forEach((status, index) => {
                                                            if (status !== order.status && 
                                                                ((status === 'Cancelled') || 
                                                                 (currentIndex < orderStatusOptions.indexOf('Delivered') && index > currentIndex && status !== 'Cancelled'))) {
                                                    %>
                                                        <option value="<%= status %>"><%= status %></option>
                                                    <% 
                                                            }
                                                        });
                                                    %>
                                                </select>
                                                <button class="btn-update-order-status" data-order-id="<%= order._id %>" disabled>
                                                    <i class="fas fa-sync"></i> Update
                                                </button>
                                            <% } else { %>
                                                <span class="final-order-status">
                                                    <i class="fas fa-check-circle"></i>
                                                    Final Status
                                                </span>
                                            <% } %>
                                        </div>
                                        <a href="/admin/orders/<%= order._id %>" class="action-btn">View Details</a>
                                    </div>
                                </div>

                                <div class="order-items">
                                    <h4>Items (<%= order.items.length %>)</h4>
                                    <div class="items-grid">
                                        <% order.items.forEach((item, index) => { %>
                                            <% const itemStatus = item.status || 'Placed'; %>
                                            <% const isFinalStatus = ['Delivered', 'Returned', 'Cancelled'].includes(itemStatus); %>
                                            <div class="item-card" data-item-id="<%= item._id %>">
                                                <div class="item-image">
                                                    <% if (item.productId?.mainImage) { %>
                                                        <img src="<%= item.productId.mainImage %>" alt="<%= item.productId?.name || 'Product' %>">
                                                    <% } else { %>
                                                        <div class="no-image">
                                                            <i class="fas fa-image"></i>
                                                        </div>
                                                    <% } %>
                                                </div>
                                                <div class="item-details">
                                                    <h5>
                                                      <% 
                                                        let productName = 'Deleted Product';
                                                        if (item.productId && item.productId.name) {
                                                          productName = item.productId.name;
                                                        } else if (item.name) {
                                                          productName = item.name;
                                                        }
                                                      %>
                                                      <%= productName %>
                                                    </h5>
                                                    <p class="item-price">$<%= item.salesPrice.toFixed(2) %> × <%= item.quantity %></p>
                                                    <div class="item-status-container">
                                                        <span class="status-badge status-<%= itemStatus.toLowerCase().replace(/\s+/g, '-') %>">
                                                            <%= itemStatus %>
                                                        </span>
                                                        <% if (item.deliveredAt) { %>
                                                            <small class="status-timestamp">Delivered: <%= item.deliveredAt.toDateString() %></small>
                                                        <% } %>
                                                        <% if (item.cancelledAt) { %>
                                                            <small class="status-timestamp">Cancelled: <%= item.cancelledAt.toDateString() %></small>
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <div class="item-actions">
                                                    <% if (!isFinalStatus) { %>
                                                        <select class="item-status-dropdown" 
                                                                data-order-id="<%= order._id %>" 
                                                                data-item-id="<%= item._id %>" 
                                                                data-current-status="<%= itemStatus %>">
                                                            <option value="">Update Status</option>
                                                            <% 
                                                                const statusOptions = ['Placed', 'Ordered', 'Processing', 'Shipped', 'Out for Delivery', 'Delivered', 'Cancelled'];
                                                                const currentIndex = statusOptions.indexOf(itemStatus);
                                                                statusOptions.forEach((status, statusIndex) => {
                                                                    // Only show valid next statuses
                                                                    if (status !== itemStatus && 
                                                                        ((status === 'Cancelled') || 
                                                                         (currentIndex < statusOptions.indexOf('Delivered') && statusIndex > currentIndex && status !== 'Cancelled'))) {
                                                            %>
                                                                <option value="<%= status %>"><%= status %></option>
                                                            <% 
                                                                    }
                                                                });
                                                            %>
                                                        </select>
                                                        <button class="btn-update-status" 
                                                                data-order-id="<%= order._id %>" 
                                                                data-item-id="<%= item._id %>"
                                                                disabled>
                                                            <i class="fas fa-sync"></i>
                                                            Update
                                                        </button>
                                                    <% } else { %>
                                                        <span class="final-status">
                                                            <i class="fas fa-check-circle"></i>
                                                            Final Status
                                                        </span>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>

                    <!-- Pagination -->
                    <% if (pagination && pagination.totalPages > 1) { %>
                        <div class="pagination-container">
                            <div class="pagination-info">
                                Showing <%= ((pagination.currentPage - 1) * 10) + 1 %> to <%= Math.min(pagination.currentPage * 10, pagination.totalOrders) %> of <%= pagination.totalOrders %> orders
                            </div>
                            <div class="pagination">
                                <% if (pagination.hasPrevPage) { %>
                                    <a href="?page=<%= pagination.prevPage %>&search=<%= search || '' %>&status=<%= status || '' %>&sort=<%= sort || 'desc' %>" class="pagination-btn">
                                        ← Previous
                                    </a>
                                <% } else { %>
                                    <span class="pagination-btn disabled">← Previous</span>
                                <% } %>

                                <% 
                                    let startPage = Math.max(1, pagination.currentPage - 2);
                                    let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
                                    
                                    if (endPage - startPage < 4) {
                                        if (startPage === 1) {
                                            endPage = Math.min(pagination.totalPages, startPage + 4);
                                        } else {
                                            startPage = Math.max(1, endPage - 4);
                                        }
                                    }
                                %>

                                <% if (startPage > 1) { %>
                                    <a href="?page=1&search=<%= search || '' %>&status=<%= status || '' %>&sort=<%= sort || 'desc' %>" class="pagination-btn">1</a>
                                    <% if (startPage > 2) { %>
                                        <span class="pagination-dots">...</span>
                                    <% } %>
                                <% } %>

                                <% for (let i = startPage; i <= endPage; i++) { %>
                                    <% if (i === pagination.currentPage) { %>
                                        <span class="pagination-btn active"><%= i %></span>
                                    <% } else { %>
                                        <a href="?page=<%= i %>&search=<%= search || '' %>&status=<%= status || '' %>&sort=<%= sort || 'desc' %>" class="pagination-btn"><%= i %></a>
                                    <% } %>
                                <% } %>

                                <% if (endPage < pagination.totalPages) { %>
                                    <% if (endPage < pagination.totalPages - 1) { %>
                                        <span class="pagination-dots">...</span>
                                    <% } %>
                                    <a href="?page=<%= pagination.totalPages %>&search=<%= search || '' %>&status=<%= status || '' %>&sort=<%= sort || 'desc' %>" class="pagination-btn"><%= pagination.totalPages %></a>
                                <% } %>

                                <% if (pagination.hasNextPage) { %>
                                    <a href="?page=<%= pagination.nextPage %>&search=<%= search || '' %>&status=<%= status || '' %>&sort=<%= sort || 'desc' %>" class="pagination-btn">
                                        Next →
                                    </a>
                                <% } else { %>
                                    <span class="pagination-btn disabled">Next →</span>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>

            <%- include('../partials/admin/footer') %>

                <script src="/js/admin/orders.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                <style>
                    /* Order Status Update Styles */
                    .order-status-update {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        margin-bottom: 0.5rem;
                    }

                    .order-status-dropdown {
                        padding: 0.4rem 0.6rem;
                        border: 2px solid #e5e7eb;
                        border-radius: 6px;
                        font-size: 0.85rem;
                        background: white;
                        min-width: 140px;
                        transition: all 0.3s ease;
                    }

                    .order-status-dropdown:focus {
                        outline: none;
                        border-color: #fca120;
                        box-shadow: 0 0 0 3px rgba(252, 161, 32, 0.1);
                    }

                    .btn-update-order-status {
                        padding: 0.4rem 0.8rem;
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 0.85rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 0.4rem;
                        white-space: nowrap;
                    }

                    .btn-update-order-status:enabled.enabled {
                        background: #fca120;
                        box-shadow: 0 2px 8px rgba(252, 161, 32, 0.3);
                        animation: pulse-orange 2s infinite;
                    }

                    .btn-update-order-status:enabled.enabled:hover {
                        background: #e8940f;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(252, 161, 32, 0.4);
                    }

                    .btn-update-order-status:disabled {
                        cursor: not-allowed;
                        opacity: 0.6;
                    }

                    .final-order-status {
                        color: #28a745;
                        font-weight: 600;
                        font-size: 0.85rem;
                        display: flex;
                        align-items: center;
                        gap: 0.4rem;
                    }

                    @keyframes pulse-orange {
                        0% {
                            box-shadow: 0 0 0 0 rgba(252, 161, 32, 0.7);
                        }
                        70% {
                            box-shadow: 0 0 0 10px rgba(252, 161, 32, 0);
                        }
                        100% {
                            box-shadow: 0 0 0 0 rgba(252, 161, 32, 0);
                        }
                    }

                    /* Pagination Styles */
                    .pagination-container {
                        margin-top: 2rem;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 1rem;
                        padding: 1rem 0;
                    }

                    .pagination-info {
                        color: #666;
                        font-size: 0.9rem;
                    }

                    .pagination {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        flex-wrap: wrap;
                        justify-content: center;
                    }

                    .pagination-btn {
                        padding: 0.5rem 0.75rem;
                        border: 1px solid #ddd;
                        background-color: #fff;
                        color: #007bff;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 0.9rem;
                        transition: all 0.3s ease;
                        min-width: 40px;
                        text-align: center;
                    }

                    .pagination-btn:hover:not(.disabled):not(.active) {
                        background-color: #f8f9fa;
                        border-color: #007bff;
                        transform: translateY(-1px);
                    }

                    .pagination-btn.active {
                        background-color: #007bff;
                        color: white;
                        border-color: #007bff;
                        font-weight: 600;
                    }

                    .pagination-btn.disabled {
                        color: #6c757d;
                        background-color: #f8f9fa;
                        border-color: #ddd;
                        cursor: not-allowed;
                    }

                    .pagination-dots {
                        padding: 0.5rem 0.25rem;
                        color: #6c757d;
                    }

                    @media (max-width: 768px) {
                        .pagination {
                            gap: 0.25rem;
                        }
                        
                        .pagination-btn {
                            padding: 0.4rem 0.6rem;
                            font-size: 0.8rem;
                            min-width: 35px;
                        }
                        
                        .pagination-info {
                            font-size: 0.8rem;
                            text-align: center;
                        }
                    }
                </style>
</body>

</html>