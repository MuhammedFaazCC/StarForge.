<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coupons - Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/css/admin/common.css">
  <link rel="stylesheet" href="/css/admin/coupon.css">
</head>
<body>
  <%- include('../partials/admin/navbar') %>
    <%- include('../partials/admin/sidepanel', { active: 'coupons' }) %>
    <div class="sidebar-backdrop" id="sidebarBackdrop" aria-hidden="true"></div>

  <div class="main-content" id="main-content">

    <div class="customers-section">
      <div class="section-header">
        <h2>Coupons</h2>
        <button type="button" class="btn-primary" onclick="openAddCouponModal()">Create Coupon</button>
      </div>

      <div id="notification-container" class="notification-container"></div>

      <% if (error) { %>
        <div class="alert error"><%= error %></div>
      <% } %>
      <% if (success) { %>
        <div class="alert success"><%= success %></div>
      <% } %>

      <div class="products-controls">
        <form class="search-form" action="/admin/coupons" method="GET">
          <input type="text" id="searchInput" name="search" placeholder="Search by code..." value="<%= search %>">
          <select name="status" onchange="this.form.submit()">
            <option value="">All Statuses</option>
            <option value="Active" <%= status === 'Active' ? 'selected' : '' %>>Active</option>
            <option value="Expired" <%= status === 'Expired' ? 'selected' : '' %>>Expired</option>
            <option value="Inactive" <%= status === 'Inactive' ? 'selected' : '' %>>Inactive</option>
          </select>
          <% if (search || status) { %>
            <a href="/admin/coupons" class="clear-search">Clear</a>
          <% } %>
        </form>
      </div>

      <div class="table-wrapper">
        <table class="customers-table">
          <thead>
            <tr>
              <th>Coupon Code</th>
              <th>Discount</th>
              <th>Min. Amount</th>
              <th>Max Order Amount</th>
              <th>Max Amount</th>
              <th>Expiry Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% coupons.forEach(coupon => { %>
              <tr>
                <td><%= coupon.code %></td>
                <td><%= coupon.discount %></td>
                <td>
                  <% if (coupon.minimumAmount > 0) { %>
                    ₹<%= coupon.minimumAmount.toLocaleString('en-IN') %>
                  <% } else { %>
                    <span style="color: #666;">No minimum</span>
                  <% } %>
                </td>
                <td>
                  <% if (coupon.orderMaxAmount > 0) { %>
                    ₹<%= coupon.orderMaxAmount.toLocaleString('en-IN') %>
                  <% } else { %>
                    <span style="color:#666;">No limit</span>
                  <% } %>
                </td>
                <td>
                  <% if (coupon.maxAmount > 0) { %>
                    ₹<%= coupon.maxAmount.toLocaleString('en-IN') %>
                  <% } else { %>
                    <span style="color:#666;">No limit</span>
                  <% } %>
                </td>
                <td><%= coupon.expiry %></td>
                <td><span class="status <%= coupon.status.toLowerCase() %>"><%= coupon.status %></span></td>
                <td>
                  <button class="btn-action btn-edit" onclick="openEditCouponModal('<%= coupon.id %>')">Edit</button>
                  <% if (coupon.status === 'Inactive') { %>
                    <button class="btn-action btn-reactivate" onclick="reactivateCoupon('<%= coupon.id %>')">Reactivate</button>
                  <% } %>
                  <button class="btn-action btn-block" onclick="deleteCoupon('<%= coupon.id %>')">Delete</button>
                </td>
              </tr>
            <% }) %>
            <% if (coupons.length === 0) { %>
              <tr class="no-results">
                <td colspan="6">No coupons found</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <% if (totalPages > 1) { %>
        <div class="pagination">
          <% if (currentPage > 1) { %>
            <button class="btn-arrow" onclick="window.location.href='?page=<%= currentPage - 1 %>&search=<%= search %>&status=<%= status %>'">Previous</button>
          <% } %>
          <% for (let i = 1; i <= totalPages; i++) { %>
            <span class="<%= currentPage === i ? 'active' : '' %>">
              <a href="?page=<%= i %>&search=<%= search %>&status=<%= status %>"><%= i %></a>
            </span>
          <% } %>
          <% if (currentPage < totalPages) { %>
            <button class="btn-arrow" onclick="window.location.href='?page=<%= currentPage + 1 %>&search=<%= search %>&status=<%= status %>'">Next</button>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Add Coupon Modal -->
  <div id="add-coupon-modal" class="confirmation-modal">
    <div class="confirmation-content" style="max-width: 500px; width: 90%;">
      <h3>Create New Coupon</h3>
      <form id="add-coupon-form">
        <div class="form-group">
          <label for="modal-code">Coupon Code *</label>
          <input type="text" id="modal-code" name="code" placeholder="e.g., SAVE10">
          <span class="error-message" id="code-error"></span>
        </div>
        
        <div class="form-group">
          <label for="modal-discount">Discount (%) *</label>
          <input type="number" id="modal-discount" name="discount" placeholder="0-100">
          <span class="error-message" id="discount-error"></span>
        </div>
        
        <div class="form-group">
          <label for="modal-expiryDate">Expiry Date *</label>
          <input type="date" id="modal-expiryDate" name="expiryDate">
          <span class="error-message" id="expiryDate-error"></span>
        </div>
        
        <div class="form-group">
          <label for="modal-usageLimit">Usage Limit *</label>
          <input type="number" id="modal-usageLimit" name="usageLimit" placeholder="e.g., 1">
          <span class="error-message" id="usageLimit-error"></span>
        </div>
        
        <div class="form-group">
          <label for="modal-minimumAmount">Minimum Order Amount (₹)</label>
          <input type="number" id="modal-minimumAmount" name="minimumAmount" placeholder="0 (no minimum)" step="0.01">
          <span class="error-message" id="minimumAmount-error"></span>
        </div>

        <div class="form-group">
          <label for="modal-orderMaxAmount">Maximum Order Amount Allowed (₹)</label>
          <input type="number" id="modal-orderMaxAmount" name="orderMaxAmount" placeholder="0 (no max)" step="0.01">
          <span class="error-message" id="orderMaxAmount-error"></span>
        </div>

        <div class="form-group">
          <label for="modal-maxAmount">Maximum Discount Amount (₹)</label>
          <input type="number" id="modal-maxAmount" name="maxAmount"  placeholder="0 (no max)" step="0.01">
          <span class="error-message" id="maxAmount-error"></span>
        </div>

        <div class="modal-actions">
          <button type="button" class="confirmation-btn cancel" onclick="closeAddCouponModal()">Cancel</button>
          <button type="submit" class="confirmation-btn confirm">Create Coupon</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Coupon Modal -->
  <div id="edit-coupon-modal" class="confirmation-modal">
    <div class="confirmation-content" style="max-width: 500px; width: 90%;">
      <h3>Edit Coupon</h3>
      <form id="edit-coupon-form">
        <input type="hidden" id="edit-coupon-id" name="couponId">
        
        <div class="form-group">
          <label for="edit-modal-code">Coupon Code *</label>
          <input type="text" id="edit-modal-code" name="code" placeholder="e.g., SAVE10">
          <span class="error-message" id="edit-code-error"></span>
        </div>
        
        <div class="form-group">
          <label for="edit-modal-discount">Discount (%) *</label>
          <input type="number" id="edit-modal-discount" name="discount" placeholder="0-100">
          <span class="error-message" id="edit-discount-error"></span>
        </div>
        
        <div class="form-group">
          <label for="edit-modal-expiryDate">Expiry Date *</label>
          <input type="date" id="edit-modal-expiryDate" name="expiryDate">
          <span class="error-message" id="edit-expiryDate-error"></span>
        </div>
        
        <div class="form-group">
          <label for="edit-modal-usageLimit">Usage Limit *</label>
          <input type="number" id="edit-modal-usageLimit" name="usageLimit" placeholder="e.g., 1">
          <span class="error-message" id="edit-usageLimit-error"></span>
        </div>
        
        <div class="form-group">
          <label for="edit-modal-minimumAmount">Minimum Order Amount (₹)</label>
          <input type="number" id="edit-modal-minimumAmount" name="minimumAmount" placeholder="0 (no minimum)" step="0.01">
          <span class="error-message" id="edit-minimumAmount-error"></span>
        </div>

        <div class="form-group">
          <label for="edit-modal-orderMaxAmount">Maximum Order Amount Allowed (₹)</label>
          <input type="number" id="edit-modal-orderMaxAmount" name="orderMaxAmount" step="0.01">
          <span id="edit-orderMaxAmount-error" class="error-message"></span>
        </div>

        <div class="form-group">
          <label for="modal-maxAmount">Maximum Discount Amount (₹)</label>
          <input type="number" id="edit-modal-maxAmount" name="maxAmount" step="0.01">
          <span id="edit-maxAmount-error" class="error-message"></span>
        </div>

        <div class="modal-actions">
          <button type="button" class="confirmation-btn cancel" onclick="closeEditCouponModal()">Cancel</button>
          <button type="submit" class="confirmation-btn confirm">Update Coupon</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirmation-modal" class="confirmation-modal">
    <div class="confirmation-content">
      <h3>Confirm Deletion</h3>
      <p id="confirmation-message">Are you sure you want to delete this coupon?</p>
      <div class="confirmation-actions">
        <button type="button" class="confirmation-btn cancel" onclick="hideConfirmationModal()">Cancel</button>
        <button type="button" class="confirmation-btn confirm" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <footer>
    <p> 2025 Admin Dashboard. All rights reserved.</p>
  </footer>

  <script src="/js/admin/common.js"></script>
  <script src="/js/admin/coupon.js"></script>

</body>
</html>