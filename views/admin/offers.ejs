<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Management - StarForge Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin/offers.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%- include('../partials/admin/navbar') %>
    <%- include('../partials/admin/sidepanel', { active: 'products' }) %>

    <div class="main-content" id="main-content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Offer Management</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="/admin/offers/add" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add New Offer
                    </a>
                </div>
            </div>

                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Discount</th>
                                        <th>Valid Period</th>
                                        <th>Status</th>
                                        <th>Usage</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (offers && offers.length > 0) { %>
                                        <% offers.forEach(offer => { %>
                                            <% 
                                                const now = new Date();
                                                const isExpired = offer.endDate < now;
                                                const isActive = offer.isActive && !isExpired;
                                                const statusClass = isExpired ? 'offer-expired' : (isActive ? 'offer-active' : 'offer-inactive');
                                                const statusText = isExpired ? 'Expired' : (isActive ? 'Active' : 'Inactive');
                                            %>
                                            <tr>
                                                <td>
                                                    <strong><%= offer.title %></strong>
                                                    <% if (offer.description) { %>
                                                        <br><small class="text-muted"><%= offer.description %></small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">
                                                        <%= offer.type.charAt(0).toUpperCase() + offer.type.slice(1) %>
                                                    </span>
                                                </td>
                                                <td><%= offer.discountPercentage %>%</td>
                                                <td>
                                                    <small>
                                                        <%= new Date(offer.startDate).toLocaleDateString() %><br>
                                                        to <%= new Date(offer.endDate).toLocaleDateString() %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <span class="offer-badge <%= statusClass %>">
                                                        <%= statusText %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <% if (offer.usageLimit) { %>
                                                        <%= offer.usedCount %>/<%= offer.usageLimit %>
                                                    <% } else { %>
                                                        <%= offer.usedCount %>/âˆž
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <a href="/admin/offers/edit/<%= offer._id %>" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <% if (!isExpired) { %>
                                                            <button class="btn btn-sm btn-outline-warning toggle-offer" data-id="<%= offer._id %>">
                                                                <i class="fas fa-<%= offer.isActive ? 'pause' : 'play' %>"></i>
                                                            </button>
                                                        <% } %>
                                                        <button class="btn btn-sm btn-outline-danger delete-offer" data-id="<%= offer._id %>">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <i class="fas fa-percent fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">No offers found</h5>
                                                <p class="text-muted">Create your first offer to get started</p>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
                            <nav aria-label="Offers pagination">
                                <ul class="pagination justify-content-center">
                                    <% if (hasPrevPage) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= prevPage %>">Previous</a>
                                        </li>
                                    <% } %>
                                    
                                    <% for (let i = 1; i <= totalPages; i++) { %>
                                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    
                                    <% if (hasNextPage) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= nextPage %>">Next</a>
                                        </li>
                                    <% } %>
                                </ul>
                            </nav>
                        <% } %>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin/editProduct.js"></script>
        </div>
    </div>

    <%- include('../partials/admin/footer') %>
</body>
</html>